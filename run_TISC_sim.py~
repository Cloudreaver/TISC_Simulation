#!/usr/bin/env python

if __name__ == '__main__':
   import ROOT
   import time
   from sum_corr import sum_correlation
   from impulse import impulse_gen
   import numpy as np
   import subprocess as Popen

   num_samples = 48
   impulse_pos = 10
   signal_amp = 10
   draw_flag = 0
   b_input_delay = 3
   c_input_delay = 5
   low_SNR = 0.0001
   high_SNR = 6.0
   step_SNR = 1.0
   low_threshold = 0.0
   high_threshold = 600.0
   step_threshold = 50.0
   num_runs = 100
   upsample = 32
   num_upsamples = upsample*num_samples

   # Get impulse signal
   a_input_signal = np.zeros(num_upsamples)
   a_input_signal = impulse_gen(num_samples,impulse_pos,upsample=upsample,draw_flag=draw_flag)
   SNR_hist = {}

   # Set up ROOT histogram
   SNR_canvas = ROOT.TCanvas('TISC_SNR', "TISC_SNR",200,10,700,500)
   ROOT.gROOT.Reset()
   ROOT.gStyle.SetOptStat("")
   ROOT.gStyle.SetTitleFillColor(10)
   ROOT.gStyle.SetTitleX(0.1)
   ROOT.gStyle.SetTitleW(0.8)

   line_color = 1
   threshold = np.linspace(low_threshold,high_threshold,(high_threshold-low_threshold)/step_threshold+1)
   print threshold

   outfile = ROOT.TFile("/home/hupe/thesis_code/output/TISC_SNR_"+str(time.strftime('%Y_%m_%d_%H.%m.%S'))+".root","RECREATE")
   #SNR_hist[1] = ROOT.TH1D('TISC_SNR','TISC SNR Curves',high_threshold/step_threshold,low_threshold,high_threshold)
   SNR_hist[0] = ROOT.TH1D('TISC_SNR','TISC SNR Curves',len(threshold),low_threshold,high_threshold)
   SNR_hist[0].SetMinimum(-0.5)
   SNR_hist[0].SetMaximum(num_runs*1.1)
   SNR_hist[0].GetYaxis().SetTitle("Counts")
   SNR_hist[0].GetXaxis().SetTitle("Threshold")
   SNR_hist[0].Draw()
   x = np.linspace(low_threshold,high_threshold,len(threshold))
   y = num_runs/2.0+0*x
   fifty_percent_eff = ROOT.TGraph(len(x),x,y)
   fifty_percent_eff.SetLineColor(20)
   fifty_percent_eff.Draw("SAME")

   legend = ROOT.TLegend(0.6,0.6,0.8,0.8)
   legend.AddEntry(fifty_percent_eff,"50% Efficency",'l')
   legend.Draw("SAME")

   SNR = np.linspace(low_SNR,high_SNR,((high_SNR-low_SNR)/step_SNR)+1)
   print SNR
   for SNR_counter in range(0,len(SNR)):
      SNR_hist[SNR[SNR_counter]] = ROOT.TH1D('TISC_SNR_'+str(SNR[SNR_counter]),'TISC SNR Curves',len(threshold),low_threshold,high_threshold)
      print len(threshold)
      print low_threshold
      print high_threshold
      for threshold_counter in range(0,len(threshold)):
         for runNum in range(0,num_runs):
            print"SNR: "+str(SNR[SNR_counter])+"\tThreshold: "+str(threshold[threshold_counter])+"\tRun Number: "+str(runNum)
            event_passed_flag = 0
            event_passed_flag = sum_correlation(SNR[SNR_counter],threshold[threshold_counter],a_input_signal,b_input_delay,c_input_delay,upsample=upsample,num_samples=num_samples,draw_flag=draw_flag)
            if(event_passed_flag):
               SNR_hist[SNR[SNR_counter]].Fill(threshold[threshold_counter])
               print "This event passed"
            print ">>>>>>>>>>>>>>>>>"
      print "Drawing histogram for SNR "+str(SNR[SNR_counter])
      SNR_hist[SNR[SNR_counter]].SetLineColor(line_color)
      SNR_hist[SNR[SNR_counter]].Draw("*,C,SAME")
      legend.AddEntry(SNR_hist[SNR[SNR_counter]],"SNR="+str(SNR[SNR_counter]),'l')
      legend.Draw("SAME")
      line_color += 1
   SNR_canvas.Update()
   print "Done itterating over steps"
      
   ROOT.gSystem.ProcessEvents()
   img = ROOT.TImage.Create()
   img.FromPad(SNR_canvas)
   img.WriteImage("output/SNR_canvas."+str(time.strftime('%Y_%m_%d_%H.%m.%S'))+'.png')

   outfile.WriteTObject(SNR_canvas)

   outfile.Write()
   outfile.Close()
   outfile.ls()
   dummy = raw_input('Press any key to close')
